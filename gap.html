<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Tauc Plotter & Bandgap Estimator</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --sidebar-width: 380px;
            --primary-bg: #f8f9fa;
            --accent-color: #4f46e5;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }
        
        /* Navbar */
        .navbar {
            background: linear-gradient(90deg, #1e293b 0%, #334155 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .navbar-brand { font-weight: 600; letter-spacing: 0.5px; }

        /* Main Layout */
        .main-container { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* Sidebar */
        .sidebar { 
            width: var(--sidebar-width); 
            min-width: var(--sidebar-width);
            background: white; 
            border-right: 1px solid #e2e8f0; 
            display: flex; 
            flex-direction: column; 
            height: 100%;
            z-index: 20;
            box-shadow: 2px 0 10px rgba(0,0,0,0.02);
        }

        .sidebar-content { flex: 1; overflow-y: auto; padding: 25px; }
        .sidebar-footer {
            padding: 20px 25px;
            background: #fff;
            border-top: 1px solid #e2e8f0;
        }

        /* Plot Area */
        .plot-area { 
            flex: 1; 
            background: #f3f4f6; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
        }

        /* Custom Cards */
        .card-custom {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            background: white;
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .card-header-custom {
            background: transparent;
            border-bottom: 1px solid #f1f5f9;
            padding: 15px;
            font-weight: 600;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Plot Containers */
        .plot-container-wrapper {
            background: white;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            height: 100%;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }
        #plotDiv, #directPlotDiv, #indirectPlotDiv { flex: 1; width: 100%; }

        /* Tables */
        .table-custom th { background-color: #f8fafc; color: #64748b; font-weight: 600; font-size: 0.85rem; }
        .table-custom td { font-size: 0.9rem; vertical-align: middle; }
        .badge-eg { font-size: 0.9em; background-color: #eff6ff; color: #2563eb; padding: 5px 10px; border-radius: 6px; border: 1px solid #bfdbfe; }

        /* Tabs */
        .nav-tabs { border-bottom: none; margin-bottom: 15px; }
        .nav-tabs .nav-link {
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .nav-tabs .nav-link:hover { background: #e2e8f0; color: #1e293b; }
        .nav-tabs .nav-link.active {
            background: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }
        
        .form-label { font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 4px; }
        .form-text { font-size: 0.75rem; color: #94a3b8; }
        .d-none-custom { display: none !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">
            <i class="bi bi-graph-up-arrow me-2"></i>Tauc Plotter 
            <span style="font-size:0.7em; font-weight:300; opacity:0.8; margin-left:10px;">UV-Vis Analysis</span>
        </span>
        <div class="text-white small opacity-75">v2.1</div>
    </div>
</nav>

<div class="main-container">
    
    <div class="sidebar">
        <div class="sidebar-content">
            
            <div class="card-custom">
                <div class="card-header-custom"><i class="bi bi-folder2-open text-primary"></i> Data Import</div>
                <div class="card-body p-3">
                    <label class="btn btn-outline-primary w-100 mb-2">
                        <i class="bi bi-upload me-2"></i>Select CSV/TXT Files
                        <input type="file" id="fileInput" multiple accept=".csv, .txt, .dat" hidden>
                    </label>
                    <div id="fileCount" class="text-center small text-muted">No files loaded</div>
                </div>
            </div>

            <div class="card-custom">
                <div class="card-header-custom"><i class="bi bi-sliders text-primary"></i> Parameters</div>
                <div class="card-body p-3">
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label">X-Axis Unit</label>
                            <select id="xUnit" class="form-select form-select-sm" onchange="recalculateAll()">
                                <option value="nm">Wavelength (nm)</option>
                                <option value="ev">Energy (eV)</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Y-Axis Type</label>

                            <select id="yType" class="form-select form-select-sm" onchange="handleYTypeChange()">
    <option value="refl" selected>Reflectance (%)</option>
    <option value="abs">Absorbance (A)</option>
    <option value="trans">Transmittance (%)</option>
</select>
                        </div>
                    </div>
                    
<div class="row g-2 d-none-custom" id="thicknessGroup">
     <div class="col-12">
        <label class="form-label">Sample Thickness (cm)</label>
        <div class="input-group input-group-sm">
            <input type="number" id="thickness" class="form-control" value="1.0" step="0.0001" onchange="recalculateAll()">
            <span class="input-group-text">cm</span>
        </div>
     </div>
</div>

                </div>
            </div>

            <div class="card-custom">
                <div class="card-header-custom">
                    <i class="bi bi-ruler text-primary"></i> Linear Fit Range
                    <button class="btn btn-link btn-sm ms-auto p-0" onclick="autoDetectRange()" title="Auto Detect"><i class="bi bi-magic fs-5"></i></button>
                </div>
                <div class="card-body p-3">
                    <p class="small text-muted mb-2">Set the Energy (eV) range to calculate the slope.</p>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Min eV</label>
                            <input type="number" id="fitMin" class="form-control form-control-sm" step="0.1" onchange="recalculateAll()">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Max eV</label>
                            <input type="number" id="fitMax" class="form-control form-control-sm" step="0.1" onchange="recalculateAll()">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="d-grid gap-2">
                <button id="btnDownload" class="btn btn-success shadow-sm" disabled onclick="downloadCSV()">
                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>Download CSV
                </button>
                <button id="btnReport" class="btn btn-primary shadow-sm" disabled onclick="generatePDF()">
                    <i class="bi bi-file-earmark-pdf me-2"></i>Generate Report
                </button>
            </div>
        </div>
    </div>

    <div class="plot-area">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#raw">Raw Spectra</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#direct">Direct Bandgap</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#indirect">Indirect Bandgap</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#help"><i class="bi bi-question-circle fs-5"></i></button></li>
        </ul>

        <div class="tab-content h-100" id="myTabContent">
            
            <div class="tab-pane fade show active h-100" id="raw">
                <div class="plot-container-wrapper">
                    <div id="plotDiv"></div>
                </div>
            </div>

            <div class="tab-pane fade h-100" id="direct">
                <div class="plot-container-wrapper mb-3" style="height: 65%;">
                    <div id="directPlotDiv"></div>
                </div>
                <div class="card-custom">
                    <div class="card-body p-0">
                        <table class="table table-custom table-hover mb-0" id="directTable">
                            <thead><tr><th>File</th><th>Eg (eV)</th><th>R²</th><th>Slope</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade h-100" id="indirect">
                <div class="plot-container-wrapper mb-3" style="height: 65%;">
                    <div id="indirectPlotDiv"></div>
                </div>
                <div class="card-custom">
                    <div class="card-body p-0">
                        <table class="table table-custom table-hover mb-0" id="indirectTable">
                            <thead><tr><th>File</th><th>Eg (eV)</th><th>R²</th><th>Slope</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="help">
                <div class="card-custom p-4" style="max-width: 800px; margin: 0 auto;">
                    <h4 class="mb-4 text-primary">Equations</h4>
                    
                    <h5 class="mt-2"> Absorbance & Transmittance Mode</h5>
                    <p class="text-muted">Calculates Absorption Coefficient (<b>&alpha;</b>) for films/liquids.</p>
                    <ul>
                        <li>Input <strong>%T</strong>: <code>A = 2 - log<sub>10</sub>(%T)</code></li>
                        <li><strong>&alpha;:</strong> <code>&alpha; = (2.303 &times; A) / d</code> (d = thickness cm)</li>
                    </ul>

                    <h5 class="mt-4"> Reflectance Mode (Kubelka-Munk)</h5>
                    <p class="text-muted">Calculates <strong>F(R)</strong> for powders/diffuse surfaces.</p>
                    <ul>
                        <li><strong>F(R):</strong> <code>F(R) = (1 - R)<sup>2</sup> / (2 &times; R)</code> (Where R is 0-1)</li>
                    </ul>

                    <h5 class="mt-4"> Tauc Equations</h5>

                    <div class="alert alert-light border">
    <strong>Direct:</strong> <code>(Y &middot; h&nu;)<sup>2</sup> = A(h&nu; - E<sub>g</sub>)</code><br>
    <strong>Indirect:</strong> <code>(Y &middot; h&nu;)<sup>0.5</sup> = B(h&nu; - E<sub>g</sub>)</code>
</div>
                    <h6>version 2.1, December 11, 2025</h6>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Global State ---
    let datasets = []; 
    const fileInput = document.getElementById('fileInput');
    const colorPalette = ['#2563eb', '#dc2626', '#16a34a', '#d97706', '#9333ea', '#0891b2', '#db2777'];

    // --- Event Listeners ---
    fileInput.addEventListener('change', handleFiles);

    // --- UI Logic ---
    function handleYTypeChange() {
        const yType = document.getElementById('yType').value;
        const thicknessGroup = document.getElementById('thicknessGroup');
        if (yType === 'refl') {
            thicknessGroup.classList.add('d-none-custom');
        } else {
            thicknessGroup.classList.remove('d-none-custom');
        }
        recalculateAll();
    }

    // --- File Handling ---
    function handleFiles(e) {
        const files = e.target.files;
        if (!files.length) return;

        datasets = []; 
        document.getElementById('fileCount').textContent = `Loading ${files.length} files...`;
        
        let filesLoaded = 0;

        Array.from(files).forEach((file, index) => {
            Papa.parse(file, {
                delimiter: "", 
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    processRawData(file.name, results.data, index);
                    filesLoaded++;
                    if (filesLoaded === files.length) {
                        document.getElementById('fileCount').textContent = `${filesLoaded} files loaded`;
                        smartDetectParams(); 
                        autoDetectRange();   
                    }
                }
            });
        });
    }

    function processRawData(filename, data, index) {
        let cleanData = data.filter(row => {
            return row.length >= 2 && typeof row[0] === 'number' && typeof row[1] === 'number';
        });

        // Ensure sorted by X
        cleanData.sort((a, b) => a[0] - b[0]);

        const rawX = cleanData.map(r => r[0]);
        const rawY = cleanData.map(r => r[1]);

        datasets.push({
            id: index,
            name: filename,
            color: colorPalette[index % colorPalette.length],
            rawX: rawX,
            rawY: rawY,
            eV: [], alphaOrF: [], directY: [], indirectY: [],
            fitDirect: {}, fitIndirect: {}
        });
    }

    // --- Smart Detection ---
    function smartDetectParams() {
        if (datasets.length === 0) return;
        const d = datasets[0];
        
        // Detect X Unit
        const maxX = Math.max(...d.rawX);
        const xSelect = document.getElementById('xUnit');
        xSelect.value = (maxX > 150) ? 'nm' : 'ev';

        // Detect Y Type
        const maxY = Math.max(...d.rawY);
        const ySelect = document.getElementById('yType');
        if (maxY > 5) {
            ySelect.value = 'refl'; 
        } else {
            ySelect.value = 'abs';
        }
        handleYTypeChange();
    }

    function autoDetectRange() {
        if (datasets.length === 0) return;
        
        const isNm = document.getElementById('xUnit').value === 'nm';
        let allEv = [];
        datasets[0].rawX.forEach(x => {
            allEv.push(isNm ? 1239.84 / x : x);
        });

        const minE = Math.min(...allEv);
        const maxE = Math.max(...allEv);
        
        // Default fit range: Top 30% of energy spectrum usually contains the edge
        document.getElementById('fitMin').value = (minE + (maxE - minE) * 0.6).toFixed(2);
        document.getElementById('fitMax').value = maxE.toFixed(2);

        recalculateAll();
    }

    // --- Calculations ---
    function recalculateAll() {
        if(datasets.length === 0) return;

        const xUnit = document.getElementById('xUnit').value;
        const yType = document.getElementById('yType').value;
        let thickness = parseFloat(document.getElementById('thickness').value);
        const fitMin = parseFloat(document.getElementById('fitMin').value);
        const fitMax = parseFloat(document.getElementById('fitMax').value);

        if (!thickness || thickness <= 0) thickness = 1.0; 

        document.getElementById('btnDownload').disabled = false;
        document.getElementById('btnReport').disabled = false;

        datasets.forEach(ds => {
            ds.eV = [];
            ds.alphaOrF = [];
            ds.directY = [];
            ds.indirectY = [];

            for (let i = 0; i < ds.rawX.length; i++) {
                const x = ds.rawX[i];
                const y = ds.rawY[i];

                // 1. Calculate eV
                let energy = (xUnit === 'nm') ? (1239.84 / x) : x;
                ds.eV.push(energy);

                // 2. Process Y based on mode
                let valForTauc = 0; 

                if (yType === 'refl') {
                    let R = y / 100;
                    if (R <= 0.0001) R = 0.0001; 
                    if (R >= 1) R = 0.9999;
                    valForTauc = Math.pow(1 - R, 2) / (2 * R);
                } else {
                    let A = 0;
                    if (yType === 'abs') {
                        A = y;
                    } else if (yType === 'trans') {
                        let T = y;
                        if (T <= 0.0001) T = 0.0001;
                        A = 2 - Math.log10(T);
                    }
                    if (A < 0) A = 0;
                    valForTauc = (2.303 * A) / thickness;
                }

                ds.alphaOrF.push(valForTauc);

                // 3. Tauc Y-axes
                ds.directY.push(Math.pow(valForTauc * energy, 2));
                ds.indirectY.push(Math.pow(valForTauc * energy, 0.5));
            }

            // Perform Fits
            ds.fitDirect = performLinearFit(ds.eV, ds.directY, fitMin, fitMax);
            ds.fitIndirect = performLinearFit(ds.eV, ds.indirectY, fitMin, fitMax);
        });

        updatePlots();
        updateTables();
    }

    function performLinearFit(xData, yData, minX, maxX) {
        let n = 0;
        let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
        let validPoints = [];

        for (let i = 0; i < xData.length; i++) {
            if (xData[i] >= minX && xData[i] <= maxX) {
                validPoints.push({x: xData[i], y: yData[i]});
                sumX += xData[i];
                sumY += yData[i];
                sumXY += (xData[i] * yData[i]);
                sumXX += (xData[i] * xData[i]);
                n++;
            }
        }

        if (n < 2) return { m: 0, c: 0, Eg: 0, R2: 0, valid: false };

        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;

        // R2 Calc
        let ssTot = 0, ssRes = 0;
        const yMean = sumY / n;
        validPoints.forEach(p => {
            const yPred = slope * p.x + intercept;
            ssTot += Math.pow(p.y - yMean, 2);
            ssRes += Math.pow(p.y - yPred, 2);
        });
        const R2 = ssTot === 0 ? 0 : 1 - (ssRes / ssTot); // Avoid div by zero

        let Eg = 0;
        // Avoid dividing by zero slope
        if (Math.abs(slope) > 1e-9) {
            Eg = -intercept / slope;
        }

        return { m: slope, c: intercept, Eg: Eg, R2: R2, valid: true, minXFit: minX, maxXFit: maxX };
    }

    function updatePlots() {
        const yType = document.getElementById('yType').value;
        const yLabelBase = (yType === 'refl') ? 'F(R)' : 'α';
        const fitMin = parseFloat(document.getElementById('fitMin').value);
        const fitMax = parseFloat(document.getElementById('fitMax').value);

        const layoutCommon = {
            margin: { t: 40, r: 20, l: 60, b: 50 },
            showlegend: true,
            legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.8)' },
            plot_bgcolor: "white",
            paper_bgcolor: "white",
            xaxis: { showgrid: true, gridcolor: '#f1f5f9', zeroline: true, zerolinecolor: '#cbd5e1' },
            yaxis: { showgrid: true, gridcolor: '#f1f5f9', zeroline: true, zerolinecolor: '#cbd5e1' },
            font: { family: 'Inter, sans-serif' }
        };

        const configCommon = { responsive: true, displaylogo: false };

        // 1. Raw Spectra
        const rawTraces = datasets.map(ds => ({
            x: ds.rawX,
            y: ds.rawY,
            mode: 'lines',
            name: ds.name,
            line: { color: ds.color, width: 2 }
        }));
        
        const xLab = document.getElementById('xUnit').value === 'nm' ? 'Wavelength (nm)' : 'Energy (eV)';
        let yLabRaw = "Value"; 
        if (yType === 'abs') yLabRaw = "Absorbance (a.u.)";
        else if (yType === 'trans') yLabRaw = "Transmittance (%)";
        else if (yType === 'refl') yLabRaw = "Reflectance (%)";

        Plotly.newPlot('plotDiv', rawTraces, 
            { ...layoutCommon, title: 'Raw Spectra', xaxis: { ...layoutCommon.xaxis, title: xLab}, yaxis: { ...layoutCommon.yaxis, title: yLabRaw} }, 
            configCommon
        );

        // Helper to generate fit traces (The Split Line Logic)
        const createFitTraces = (ds, yDataArr, fitObj, yLabel) => {
            let traces = [];
            // Data Trace
            traces.push({ 
                x: ds.eV, 
                y: yDataArr, 
                mode: 'lines', 
                name: ds.name, 
                line: {width: 2, color: ds.color, opacity: 0.6} 
            });

            if (fitObj.valid && fitObj.m !== 0) {
                // 1. The Extrapolation Line (Thin, Dashed, from Eg to minFit)
                const xExtra = [fitObj.Eg, fitObj.minXFit];
                const yExtra = [0, fitObj.m * fitObj.minXFit + fitObj.c];
                
                traces.push({ 
                    x: xExtra, y: yExtra, mode: 'lines', 
                    name: `Extrap. (${ds.name})`,
                    showlegend: false,
                    line: { dash: 'dash', width: 1, color: 'black' },
                    hoverinfo: 'skip'
                });

                // 2. The Active Fit Line (Thick, Solid, from minFit to maxFit)
                const xActive = [fitObj.minXFit, fitObj.maxXFit];
                const yActive = [fitObj.m * fitObj.minXFit + fitObj.c, fitObj.m * fitObj.maxXFit + fitObj.c];

                traces.push({ 
                    x: xActive, y: yActive, mode: 'lines', 
                    name: `Fit Eg=${fitObj.Eg.toFixed(2)}`,
                    line: { dash: 'solid', width: 4, color: 'red' } // Thicker line requested
                });
            }
            return traces;
        };

        // 2. Direct Plot
        let directTraces = [];
        datasets.forEach(ds => {
            directTraces.push(...createFitTraces(ds, ds.directY, ds.fitDirect, `(${yLabelBase}hν)²`));
        });
        Plotly.newPlot('directPlotDiv', directTraces, 
            { ...layoutCommon, title: 'Direct Bandgap', xaxis: { ...layoutCommon.xaxis, title: 'Energy (eV)'}, yaxis: { ...layoutCommon.yaxis, title: `(${yLabelBase}hν)²`} }, 
            configCommon
        );

        // 3. Indirect Plot
        let indirectTraces = [];
        datasets.forEach(ds => {
            indirectTraces.push(...createFitTraces(ds, ds.indirectY, ds.fitIndirect, `(${yLabelBase}hν)½`));
        });
        Plotly.newPlot('indirectPlotDiv', indirectTraces, 
            { ...layoutCommon, title: 'Indirect Bandgap', xaxis: { ...layoutCommon.xaxis, title: 'Energy (eV)'}, yaxis: { ...layoutCommon.yaxis, title: `(${yLabelBase}hν)½`} }, 
            configCommon
        );
    }

    function updateTables() {
        const updateTbody = (id, key) => {
            const tbody = document.querySelector(`#${id} tbody`);
            tbody.innerHTML = '';
            datasets.forEach(ds => {
                const fit = ds[key];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span style="color:${ds.color}">●</span> ${ds.name}</td>
                    <td><span class="badge-eg">${fit.Eg.toFixed(3)} eV</span></td>
                    <td>${fit.R2.toFixed(4)}</td>
                    <td class="text-muted small">${fit.m.toExponential(2)}</td>`;
                tbody.appendChild(tr);
            });
        };
        updateTbody('directTable', 'fitDirect');
        updateTbody('indirectTable', 'fitIndirect');
    }

    // --- Export Functions ---
    function downloadCSV() {
        if (!datasets || datasets.length === 0) return;
        
        const esc = (val) => {
            if (val === null || val === undefined) return "";
            const str = String(val);
            return str.includes(",") ? `"${str}"` : str;
        };

        let rows = [];
        rows.push(["=== SUMMARY RESULTS ==="]);
        rows.push(["File Name", "Bandgap Mode", "Eg (eV)", "R-Squared", "Slope", "Intercept"].join(","));

        datasets.forEach(ds => {
            rows.push([esc(ds.name), "Direct (n=2)", ds.fitDirect.Eg.toFixed(4), ds.fitDirect.R2.toFixed(4), ds.fitDirect.m.toExponential(4), ds.fitDirect.c.toExponential(4)].join(","));
            rows.push([esc(ds.name), "Indirect (n=1/2)", ds.fitIndirect.Eg.toFixed(4), ds.fitIndirect.R2.toFixed(4), ds.fitIndirect.m.toExponential(4), ds.fitIndirect.c.toExponential(4)].join(","));
        });

        rows.push([], [], ["=== SPECTRAL DATA ==="]);
        let dataHeader = ["Index"];
        datasets.forEach(ds => {
            const n = esc(ds.name);
            dataHeader.push(`${n}_eV`, `${n}_Raw`, `${n}_ProcessedY`, `${n}_DirectY`, `${n}_IndirectY`);
        });
        rows.push(dataHeader.join(","));

        const maxLen = Math.max(...datasets.map(d => d.eV.length));
        for (let i = 0; i < maxLen; i++) {
            let row = [i];
            datasets.forEach(ds => {
                if (i < ds.eV.length) {
                    row.push(ds.eV[i].toFixed(5), ds.rawY[i].toFixed(5), ds.alphaOrF[i].toFixed(5), ds.directY[i].toFixed(5), ds.indirectY[i].toFixed(5));
                } else {
                    row.push("","","","","");
                }
            });
            rows.push(row.join(","));
        }

        const blob = new Blob([rows.join("\r\n")], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `tauc_analysis_${Date.now()}.csv`;
        link.click();
    }

    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const date = new Date().toLocaleString();
        const yType = document.getElementById('yType').value;

        // Header
        doc.setFillColor(30, 41, 59); // Dark Blue
        doc.rect(0, 0, 210, 20, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(14);
        doc.text("Tauc Plot Analysis Report", 14, 13);
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        doc.text(`Generated: ${date}`, 14, 30);
        doc.text(`Mode: ${yType.toUpperCase()}`, 14, 35);

        let yPos = 45;
        const addTableToPdf = (title, tableId) => {
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(title, 14, yPos);
            yPos += 7;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tr');
            
            // Header Row
            doc.setFillColor(241, 245, 249);
            doc.rect(14, yPos - 4, 180, 6, 'F');
            
            rows.forEach((row, idx) => {
                let xPos = 14;
                const cols = row.querySelectorAll('th, td');
                cols.forEach((col, cIdx) => { 
                    // Simple column spacing
                    let txt = col.innerText.trim();
                    doc.text(txt, xPos, yPos);
                    xPos += (cIdx === 0) ? 80 : 35; // First col wider
                });
                yPos += 6;
            });
            yPos += 10;
        };

        addTableToPdf("Direct Bandgap Results", "directTable");
        addTableToPdf("Indirect Bandgap Results", "indirectTable");

        const grabPlot = async (divId) => {
            return await Plotly.toImage(document.getElementById(divId), {format: 'png', width: 800, height: 500, scale: 2});
        };

        if (yPos > 180) { doc.addPage(); yPos = 20; }
        
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text("Direct Tauc Plot", 14, yPos);
        const imgDirect = await grabPlot('directPlotDiv');
        doc.addImage(imgDirect, 'PNG', 15, yPos + 5, 180, 110);
        
        doc.addPage();
        doc.text("Indirect Tauc Plot", 14, 20);
        const imgIndirect = await grabPlot('indirectPlotDiv');
        doc.addImage(imgIndirect, 'PNG', 15, 25, 180, 110);

        doc.save(`Tauc_Report_${Date.now()}.pdf`);
    }
</script>

</body>
</html>