<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tauc Plotter & Bandgap</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --sidebar-width: 400px;
            --primary-bg: #f8f9fa;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }
        
        /* Navbar */
        .navbar {
            background: linear-gradient(90deg, #0f172a 0%, #334155 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            height: 50px;
        }
        .navbar-brand { font-size: 1rem; font-weight: 600; letter-spacing: 0.5px; }

        /* Main Layout */
        .main-container { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* Sidebar */
        .sidebar { 
            width: var(--sidebar-width); 
            min-width: var(--sidebar-width);
            background: white; 
            border-right: 1px solid #e2e8f0; 
            display: flex; 
            flex-direction: column; 
            height: 100%;
            z-index: 20;
            box-shadow: 2px 0 10px rgba(0,0,0,0.02);
        }

        .sidebar.drag-over {
    background-color: #eff6ff !important; /* Light blue background */
    border: 2px dashed #3b82f6 !important; /* Blue dashed border */
    transition: all 0.2s ease;
}

        .sidebar-header {
            padding: 10px 15px;
            background: #fff;
            border-bottom: 1px solid #e2e8f0;
        }

        .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc; }
        .sidebar-footer {
            padding: 15px;
            background: #fff;
            border-top: 1px solid #e2e8f0;
        }

        /* Sidebar Tabs */
        .nav-pills-custom .nav-link {
            color: #64748b;
            font-size: 0.9rem;
            padding: 8px 15px;
            border-radius: 6px;
        }
        .nav-pills-custom .nav-link.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }

        /* File List Items */
        .file-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .file-item:hover { border-color: #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .file-item.active-edit {
            border-color: #3b82f6;
            background-color: #eff6ff;
            border-left: 4px solid #3b82f6;
        }
        .file-name {
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        /* Plot Area */
        .plot-area { 
            flex: 1; 
            background: #f3f4f6; 
            padding: 15px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
        }

        /* Custom Cards */
        .card-custom {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            background: white;
            margin-bottom: 15px;
        }
        .card-header-custom {
            background: transparent;
            border-bottom: 1px solid #f1f5f9;
            padding: 12px 15px;
            font-weight: 600;
            color: #334155;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Plot Containers */
        .plot-container-wrapper {
            background: white;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            height: 100%;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }
        #plotDiv, #directPlotDiv, #indirectPlotDiv { flex: 1; width: 100%; }

        /* Tables */
        .table-custom th { background-color: #f8fafc; color: #64748b; font-weight: 600; font-size: 0.8rem; }
        .table-custom td { font-size: 0.85rem; vertical-align: middle; }
        .badge-eg { font-size: 0.9em; background-color: #eff6ff; color: #2563eb; padding: 4px 8px; border-radius: 4px; border: 1px solid #bfdbfe; }

        .active-file-indicator {
            background: #dbeafe;
            color: #1e40af;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid #bfdbfe;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .d-none-custom { display: none !important; }
        
        /* Range Slider Stylings */
        .range-wrap { margin-bottom: 10px; }
        .form-range::-webkit-slider-thumb { background: #3b82f6; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">
            <i class="bi bi-layers-half me-2"></i>Tauc Plotter 
            <span style="font-size:0.7em; font-weight:300; opacity:0.8; margin-left:10px;">v3.0</span>
        </span>
        <label class="btn btn-sm btn-outline-light" style="border-color: rgba(255,255,255,0.3);">
            <i class="bi bi-plus-lg me-1"></i>Add Files
            <input type="file" id="fileInput" multiple accept=".csv, .txt, .dat" hidden>
        </label>
    </div>
</nav>

<div class="main-container">
    
    <div class="sidebar">
        <div class="sidebar-header">
            <ul class="nav nav-pills nav-pills-custom nav-fill" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tab-files-btn" data-bs-toggle="pill" data-bs-target="#tab-files" type="button"><i class="bi bi-list-ul me-1"></i> File List</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-params-btn" data-bs-toggle="pill" data-bs-target="#tab-params" type="button" disabled><i class="bi bi-sliders me-1"></i> Analysis</button>
                </li>
            </ul>
        </div>

        <div class="sidebar-content">
            <div class="tab-content h-100">
                
                <div class="tab-pane fade show active" id="tab-files">
                    <div id="emptyState" class="text-center text-muted mt-5">
                        <i class="bi bi-cloud-upload fs-1 opacity-25"></i>
                        <p class="small mt-2">No files loaded.<br>Click "Add Files" top right <br> or drop one or several files here.</p>
                    </div>
                    <div id="fileListContainer">
                        </div>
                </div>

                <div class="tab-pane fade" id="tab-params">
                    
                    <div class="active-file-indicator">
                        <span><i class="bi bi-pencil-square me-1"></i> Editing: <strong id="activeFileName">None</strong></span>
                    </div>

                    <div class="card-custom">
                        <div class="card-header-custom"><i class="bi bi-arrow-left-right text-primary"></i> Units & Type</div>
                        <div class="card-body p-3">
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="form-label small fw-bold">X-Axis Unit</label>
                                    <select id="xUnit" class="form-select form-select-sm" onchange="updateActiveParam('xUnit')">
                                        <option value="nm">Wavelength (nm)</option>
                                        <option value="ev">Energy (eV)</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-bold">Y-Axis Mode</label>
                                    <select id="yType" class="form-select form-select-sm" onchange="updateActiveParam('yType')">
                                        <option value="refl">Reflectance (%)</option>
                                        <option value="abs">Absorbance (A)</option>
                                        <option value="trans">Transmittance (%)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row g-2 d-none-custom" id="thicknessGroup">
                                <div class="col-12">
                                    <label class="form-label small fw-bold">Sample Thickness (cm)</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="thickness" class="form-control" step="0.0001" onchange="updateActiveParam('thickness')">
                                        <span class="input-group-text">cm</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-custom">
                        <div class="card-header-custom">
                            <i class="bi bi-ruler text-primary"></i> Fit Range (eV)
                            <button class="btn btn-link btn-sm ms-auto p-0" onclick="autoDetectRangeForActive()" title="Auto Detect"><i class="bi bi-magic fs-6"></i></button>
                        </div>
                        <div class="card-body p-3">
                            <div class="range-wrap">
                                <div class="d-flex justify-content-between mb-1">
                                    <label class="small text-muted">Min eV</label>
                                    <span id="lblMin" class="badge bg-light text-dark border">0.00</span>
                                </div>
                                <input type="range" id="fitMin" class="form-range" step="0.01" oninput="updateActiveParam('fitMin')">
                            </div>
                            
                            <div class="range-wrap">
                                <div class="d-flex justify-content-between mb-1">
                                    <label class="small text-muted">Max eV</label>
                                    <span id="lblMax" class="badge bg-light text-dark border">0.00</span>
                                </div>
                                <input type="range" id="fitMax" class="form-range" step="0.01" oninput="updateActiveParam('fitMax')">
                            </div>
                            <div class="text-muted" style="font-size:0.75rem; line-height:1.2;">
                                <i class="bi bi-info-circle me-1"></i>Only data points within this range are used for the linear regression.
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

<div class="sidebar-footer">
    <div class="row g-2"> <div class="col-6"> <button id="btnDownload" class="btn btn-success shadow-sm w-100" style="padding: 8px 15px;" disabled onclick="downloadCSV()">
                <i class="bi bi-file-earmark-spreadsheet me-2"></i>Download CSV
            </button>
        </div>
        <div class="col-6"> <button id="btnReport" class="btn btn-primary shadow-sm w-100" style="padding: 8px 15px;" disabled onclick="generatePDF()">
                <i class="bi bi-file-earmark-pdf me-2"></i>PDF Report
            </button>
        </div>
    </div>
</div>

    </div>

    <div class="plot-area">
        <ul class="nav nav-tabs" id="plotTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#raw">Raw Spectra</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#direct">Direct Bandgap</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#indirect">Indirect Bandgap</button></li>
            <li class="nav-item ms-auto">
                <button class="nav-link text-muted" data-bs-toggle="tab" data-bs-target="#help" title="Help & Equations">
                    <i class="bi bi-question-circle-fill"></i>
                </button>
            </li>
        </ul>

        <div class="tab-content h-100" id="plotTabContent">
            
            <div class="tab-pane fade show active h-100" id="raw">
                <div class="plot-container-wrapper mt-3">
                    <div id="plotDiv"></div>
                </div>
            </div>

            <div class="tab-pane fade h-100" id="direct">
                <div class="plot-container-wrapper mt-3 mb-3" style="height: 60%;">
                    <div id="directPlotDiv"></div>
                </div>
                <div class="card-custom" style="height: 30%; overflow-y:auto;">
                    <div class="card-body p-0">
                        <table class="table table-custom table-hover mb-0 sticky-top" id="directTable">
                            <thead><tr><th>File</th><th>Eg (eV)</th><th>R²</th><th>Slope</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade h-100" id="indirect">
                <div class="plot-container-wrapper mt-3 mb-3" style="height: 60%;">
                    <div id="indirectPlotDiv"></div>
                </div>
                <div class="card-custom" style="height: 30%; overflow-y:auto;">
                    <div class="card-body p-0">
                        <table class="table table-custom table-hover mb-0 sticky-top" id="indirectTable">
                            <thead><tr><th>File</th><th>Eg (eV)</th><th>R²</th><th>Slope</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
           
            <div class="tab-pane fade h-100" id="help" style="overflow-y: auto;">
                <div class="card-custom p-4 mt-3" style="max-width: 800px; margin: 0 auto;">
                    <h4 class="mb-4 text-primary"><i class="bi bi-book me-2"></i>Documentation & Math</h4>
                    
                    <h5 class="mt-2 text-dark"><i class="bi bi-1-circle me-2"></i>Multi-File Workflow</h5>
                    <p class="text-muted small">This tool allows you to analyze multiple datasets simultaneously.</p>
                    <ul class="small text-muted">
                        <li><strong>Import:</strong> Upload one or multiple .csv/.txt files at once with Add Files or by drag and drop.</li>
                        <li><strong>Select to Edit:</strong> In the <em>File List</em> (sidebar), click the <i class="bi bi-pencil-square"></i> icon next to a file to make it "Active".</li>
                        <li><strong>Adjust:</strong> Switch to the <em>Analysis</em> tab in the sidebar. Any changes to units, thickness, or fit range apply <strong>only</strong> to the active file.</li>
                        <li><strong>Compare:</strong> Use the checkboxes in the File List to hide/show specific plots.</li>
                    </ul>
                    <hr class="my-4">

                    <h5 class="mt-2 text-dark">Absorbance & Transmittance Mode</h5>
                    <p class="text-muted small">Calculates Absorption Coefficient (<b>&alpha;</b>) for films or liquids.</p>
                    <ul class="small text-muted">
                        <li>Input <strong>%T</strong> is converted: <code>A = 2 - log<sub>10</sub>(%T)</code></li>
                        <li><strong>&alpha;:</strong> <code>&alpha; = (2.303 &times; A) / d</code> <br>(Where <em>d</em> is sample thickness in cm)</li>
                    </ul>

                    <h5 class="mt-4 text-dark">Reflectance Mode (Kubelka-Munk)</h5>
                    <p class="text-muted small">Calculates <strong>F(R)</strong> for powders and diffuse surfaces.</p>
                    <ul class="small text-muted">
                        <li><strong>F(R):</strong> <code>F(R) = (1 - R)<sup>2</sup> / (2 &times; R)</code></li>
                        <li><em>Note:</em> R is automatically normalized to 0-1 range if input is %.</li>
                    </ul>

                    <h5 class="mt-4 text-dark">Tauc Equations</h5>
                    <div class="alert alert-light border small">
                        <strong>General Equation:</strong> <code>(Y &middot; h&nu;)<sup>1/n</sup> = A(h&nu; - E<sub>g</sub>)</code>
                        <div class="mt-2">
                            <strong>Direct Bandgap (n=1/2):</strong> Plot <code>(Y &middot; h&nu;)<sup>2</sup></code> vs Energy.<br>
                            <strong>Indirect Bandgap (n=2):</strong> Plot <code>(Y &middot; h&nu;)<sup>0.5</sup></code> vs Energy.
                        </div>
                    </div>

                    <h5 class="mt-4 text-dark"><i class="bi bi-magic me-2"></i>Auto-Detect Features</h5>
                    <p class="text-muted small">
                        The "Magic Wand" button in the Analysis tab automatically attempts to find the linear region of the absorption edge. 
                        It defaults to the top 40% of the energy spectrum where the fundamental absorption usually occurs.
                    </p>

                    <div class="mt-5 text-end text-muted opacity-50" style="font-size: 0.75rem;">Multi-Tauc v3.0, version 12.12.2025 </div>
                </div>
            </div>

        </div> </div> </div> 

<script>

document.addEventListener('DOMContentLoaded', () => {

    // --- Global State ---
    let datasets = []; 
    let activeDatasetId = null;
    let fileCounter = 0; 
    const colorPalette = ['#2563eb', '#dc2626', '#16a34a', '#d97706', '#9333ea', '#0891b2', '#db2777', '#4b5563'];

    // --- DOM Elements ---
    const fileInput = document.getElementById('fileInput');
    const sidebar = document.querySelector('.sidebar'); // Select the sidebar
    const fileListContainer = document.getElementById('fileListContainer');
    const emptyState = document.getElementById('emptyState');
    const tabParamsBtn = document.getElementById('tab-params-btn');
    
    // Inputs
    const domInputs = {
        xUnit: document.getElementById('xUnit'),
        yType: document.getElementById('yType'),
        thickness: document.getElementById('thickness'),
        fitMin: document.getElementById('fitMin'),
        fitMax: document.getElementById('fitMax'),
        lblMin: document.getElementById('lblMin'),
        lblMax: document.getElementById('lblMax'),
        thicknessGroup: document.getElementById('thicknessGroup'),
        activeFileName: document.getElementById('activeFileName')
    };

    // --- Event Listeners ---
    
    // 1. Standard Button Input
    if(fileInput) {
        fileInput.addEventListener('change', (e) => {
            processBatch(e.target.files);
            e.target.value = ''; // Reset input
        });
    }

    // 2. Drag and Drop on Sidebar
    if (sidebar) {
        // Prevent default browser behavior to allow drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            sidebar.addEventListener(eventName, preventDefaults, false);
        });

        // Add visual style when dragging over
        ['dragenter', 'dragover'].forEach(eventName => {
            sidebar.addEventListener(eventName, () => sidebar.classList.add('drag-over'), false);
        });

        // Remove visual style when leaving or dropping
        ['dragleave', 'drop'].forEach(eventName => {
            sidebar.addEventListener(eventName, () => sidebar.classList.remove('drag-over'), false);
        });

        // Handle the dropped files
        sidebar.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            processBatch(files);
        }, false);
    }

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // Plot Resize on Tab Change
    document.querySelectorAll('button[data-bs-toggle="pill"], button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', triggerResize);
        tab.addEventListener('shown.bs.pill', triggerResize);
    });

    function triggerResize() {
        if(datasets.length > 0) {
            Plotly.Plots.resize(document.getElementById('plotDiv'));
            Plotly.Plots.resize(document.getElementById('directPlotDiv'));
            Plotly.Plots.resize(document.getElementById('indirectPlotDiv'));
        }
    }

    // --- File Processing Logic ---
    function processBatch(files) {
        if (!files || files.length === 0) return;
        
        let loadedCount = 0;
        const totalFiles = files.length;

        Array.from(files).forEach((file) => {
            // Check for DSW
            if (file.name.toUpperCase().endsWith('.DSW')) {
                alert(`File "${file.name}" is a binary Varian DSW file.\nPlease convert to CSV first.`);
                loadedCount++;
                checkCompletion(loadedCount, totalFiles);
                return;
            }

            Papa.parse(file, {
                delimiter: "", 
                skipEmptyLines: true,
                dynamicTyping: true,
                error: function(err) {
                    console.error("Error parsing file:", file.name, err);
                    loadedCount++;
                    checkCompletion(loadedCount, totalFiles);
                },
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        addDataset(file.name, results.data);
                    }
                    loadedCount++;
                    checkCompletion(loadedCount, totalFiles);
                }
            });
        });
    }

    function checkCompletion(current, total) {
        if (current === total) {
            renderFileList();
            if (activeDatasetId === null && datasets.length > 0) {
                setActiveDataset(datasets[datasets.length - 1].id);
            }
            updateAllPlots();
        }
    }

    function addDataset(filename, data) {
        // Filter for valid numeric rows
        let cleanData = data.filter(row => {
            return row.length >= 2 && 
                   typeof row[0] === 'number' && !isNaN(row[0]) &&
                   typeof row[1] === 'number' && !isNaN(row[1]);
        });

        if (cleanData.length < 2) return;

        cleanData.sort((a, b) => a[0] - b[0]);
        const rawX = cleanData.map(r => r[0]);
        const rawY = cleanData.map(r => r[1]);

        const maxX = Math.max(...rawX);
        const maxY = Math.max(...rawY);
        const defaultXUnit = (maxX > 150) ? 'nm' : 'ev';
        const defaultYType = (maxY > 5) ? 'refl' : 'abs';

        let allEv = [];
        rawX.forEach(x => {
            if(x !== 0) allEv.push(defaultXUnit === 'nm' ? 1239.84/x : x);
        });
        
        const minE = allEv.length ? Math.min(...allEv) : 0;
        const maxE = allEv.length ? Math.max(...allEv) : 10;
        const defaultMin = (minE + (maxE - minE) * 0.6); 
        const defaultMax = maxE;

        const id = fileCounter++;
        
        datasets.push({
            id: id,
            name: filename,
            color: colorPalette[id % colorPalette.length],
            visible: true,
            rawX: rawX,
            rawY: rawY,
            params: {
                xUnit: defaultXUnit,
                yType: defaultYType,
                thickness: 1.0,
                fitMin: defaultMin,
                fitMax: defaultMax,
                sliderMinBound: minE, 
                sliderMaxBound: maxE
            },
            calc: { eV: [], alphaOrF: [], directY: [], indirectY: [], fitDirect: {}, fitIndirect: {} }
        });

        calculateDataset(datasets[datasets.length - 1]);
    }

    // --- UI Rendering ---
    function renderFileList() {
        if (datasets.length === 0) {
            emptyState.style.display = 'block';
            fileListContainer.innerHTML = '';
            document.getElementById('btnDownload').disabled = true;
            document.getElementById('btnReport').disabled = true;
            tabParamsBtn.disabled = true;
            return;
        }

        emptyState.style.display = 'none';
        document.getElementById('btnDownload').disabled = false;
        document.getElementById('btnReport').disabled = false;
        tabParamsBtn.disabled = false;

        let html = '';
        datasets.forEach(ds => {
            const isActive = ds.id === activeDatasetId;
            const activeClass = isActive ? 'active-edit' : '';
            const checked = ds.visible ? 'checked' : '';
            
            html += `
            <div class="file-item ${activeClass}" id="file-item-${ds.id}">
                <div class="form-check m-0">
                    <input class="form-check-input" type="checkbox" ${checked} onchange="toggleVisibility(${ds.id})">
                </div>
                <div class="file-name" title="${ds.name}" style="color:${ds.color}; cursor:pointer;" onclick="setActiveDataset(${ds.id})">
                    <i class="bi bi-circle-fill me-1" style="font-size:0.6em"></i>${ds.name}
                </div>
                <button class="btn btn-sm btn-outline-primary border-0" onclick="setActiveDataset(${ds.id})" title="Edit Settings">
                    <i class="bi bi-pencil-square"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger border-0" onclick="removeDataset(${ds.id})" title="Remove">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>`;
        });
        fileListContainer.innerHTML = html;
    }

    // --- State Management ---
    window.setActiveDataset = function(id) {
        activeDatasetId = id;
        renderFileList(); 

        const ds = datasets.find(d => d.id === id);
        if (!ds) return;

        const tabTrigger = new bootstrap.Tab(tabParamsBtn);
        tabTrigger.show();

        domInputs.activeFileName.textContent = ds.name;
        domInputs.activeFileName.style.color = ds.color;
        
        domInputs.xUnit.value = ds.params.xUnit;
        domInputs.yType.value = ds.params.yType;
        domInputs.thickness.value = ds.params.thickness;

        if (ds.params.yType === 'refl') domInputs.thicknessGroup.classList.add('d-none-custom');
        else domInputs.thicknessGroup.classList.remove('d-none-custom');

        domInputs.fitMin.min = ds.params.sliderMinBound.toFixed(2);
        domInputs.fitMin.max = ds.params.sliderMaxBound.toFixed(2);
        domInputs.fitMax.min = ds.params.sliderMinBound.toFixed(2);
        domInputs.fitMax.max = ds.params.sliderMaxBound.toFixed(2);

        domInputs.fitMin.value = ds.params.fitMin;
        domInputs.fitMax.value = ds.params.fitMax;
        
        domInputs.lblMin.textContent = parseFloat(ds.params.fitMin).toFixed(2);
        domInputs.lblMax.textContent = parseFloat(ds.params.fitMax).toFixed(2);
    };

    window.toggleVisibility = function(id) {
        const ds = datasets.find(d => d.id === id);
        if (ds) {
            ds.visible = !ds.visible;
            updateAllPlots();
            renderFileList(); 
        }
    };

    window.removeDataset = function(id) {
        datasets = datasets.filter(d => d.id !== id);
        if (activeDatasetId === id) {
            activeDatasetId = datasets.length > 0 ? datasets[0].id : null;
            if(activeDatasetId !== null) setActiveDataset(activeDatasetId);
            else {
                document.getElementById('tab-files-btn').click();
            }
        }
        renderFileList();
        updateAllPlots();
    };

    window.updateActiveParam = function(paramName) {
        if (activeDatasetId === null) return;
        const ds = datasets.find(d => d.id === activeDatasetId);
        
        let val;
        if (paramName === 'xUnit' || paramName === 'yType') {
            val = domInputs[paramName].value;
            if (paramName === 'yType') {
                if (val === 'refl') domInputs.thicknessGroup.classList.add('d-none-custom');
                else domInputs.thicknessGroup.classList.remove('d-none-custom');
            }
            if (paramName === 'xUnit') {
                let allEv = [];
                ds.rawX.forEach(x => {
                    if(x!==0) allEv.push(val === 'nm' ? 1239.84/x : x);
                });
                ds.params.sliderMinBound = allEv.length ? Math.min(...allEv) : 0;
                ds.params.sliderMaxBound = allEv.length ? Math.max(...allEv) : 10;
                
                domInputs.fitMin.min = ds.params.sliderMinBound.toFixed(2);
                domInputs.fitMin.max = ds.params.sliderMaxBound.toFixed(2);
                domInputs.fitMax.min = ds.params.sliderMinBound.toFixed(2);
                domInputs.fitMax.max = ds.params.sliderMaxBound.toFixed(2);
                
                ds.params.fitMin = ds.params.sliderMinBound;
                ds.params.fitMax = ds.params.sliderMaxBound;
                domInputs.fitMin.value = ds.params.fitMin;
                domInputs.fitMax.value = ds.params.fitMax;
            }
        } else {
            val = parseFloat(domInputs[paramName].value);
            if (paramName === 'fitMin') domInputs.lblMin.textContent = val.toFixed(2);
            if (paramName === 'fitMax') domInputs.lblMax.textContent = val.toFixed(2);
        }

        ds.params[paramName] = val;
        calculateDataset(ds);
        updateAllPlots();
    };

    window.autoDetectRangeForActive = function() {
        if (activeDatasetId === null) return;
        const ds = datasets.find(d => d.id === activeDatasetId);
        
        const min = ds.params.sliderMinBound;
        const max = ds.params.sliderMaxBound;
        const newMin = min + (max - min) * 0.6;
        
        ds.params.fitMin = newMin;
        ds.params.fitMax = max;
        
        domInputs.fitMin.value = newMin;
        domInputs.fitMax.value = max;
        domInputs.lblMin.textContent = newMin.toFixed(2);
        domInputs.lblMax.textContent = max.toFixed(2);

        calculateDataset(ds);
        updateAllPlots();
    };

    // --- Core Math ---
    function calculateDataset(ds) {
        ds.calc.eV = [];
        ds.calc.alphaOrF = [];
        ds.calc.directY = [];
        ds.calc.indirectY = [];

        const { xUnit, yType, thickness, fitMin, fitMax } = ds.params;

        for (let i = 0; i < ds.rawX.length; i++) {
            const x = ds.rawX[i];
            const y = ds.rawY[i];

            if(x === 0) continue; 

            let energy = (xUnit === 'nm') ? (1239.84 / x) : x;
            ds.calc.eV.push(energy);

            let valForTauc = 0;
            if (yType === 'refl') {
                let R = y / 100;
                if (R <= 0.0001) R = 0.0001;
                if (R >= 1) R = 0.9999;
                valForTauc = Math.pow(1 - R, 2) / (2 * R);
            } else {
                let A = 0;
                if (yType === 'abs') A = y;
                else if (yType === 'trans') {
                    let T = y;
                    if (T <= 0.0001) T = 0.0001;
                    A = 2 - Math.log10(T);
                }
                if (A < 0) A = 0;
                valForTauc = (2.303 * A) / (thickness || 1.0);
            }

            ds.calc.alphaOrF.push(valForTauc);
            ds.calc.directY.push(Math.pow(valForTauc * energy, 2));
            ds.calc.indirectY.push(Math.pow(valForTauc * energy, 0.5));
        }

        ds.calc.fitDirect = performLinearFit(ds.calc.eV, ds.calc.directY, fitMin, fitMax);
        ds.calc.fitIndirect = performLinearFit(ds.calc.eV, ds.calc.indirectY, fitMin, fitMax);
    }

    function performLinearFit(xData, yData, minX, maxX) {
        let n = 0;
        let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
        let validPoints = [];

        for (let i = 0; i < xData.length; i++) {
            if (xData[i] >= minX && xData[i] <= maxX) {
                validPoints.push({x: xData[i], y: yData[i]});
                sumX += xData[i];
                sumY += yData[i];
                sumXY += (xData[i] * yData[i]);
                sumXX += (xData[i] * xData[i]);
                n++;
            }
        }

        if (n < 3) return { m: 0, c: 0, Eg: 0, EgErr: 0, R2: 0, valid: false };

        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        let ssTot = 0, ssRes = 0;
        const yMean = sumY / n;
        const meanX = sumX / n;

        validPoints.forEach(p => {
            const yPred = slope * p.x + intercept;
            ssTot += Math.pow(p.y - yMean, 2);
            ssRes += Math.pow(p.y - yPred, 2);
        });
        
        const R2 = ssTot === 0 ? 0 : 1 - (ssRes / ssTot);
        let Eg = 0, EgErr = 0;
        
        if (Math.abs(slope) > 1e-9) {
            Eg = -intercept / slope;
            const syx = Math.sqrt(ssRes / (n - 2)); 
            const Sxx = sumXX - (sumX * sumX) / n;
            EgErr = (syx / Math.abs(slope)) * Math.sqrt(1/n + Math.pow(meanX - Eg, 2)/Sxx);
        }

        return { m: slope, c: intercept, Eg: Eg, EgErr: EgErr, R2: R2, valid: true, minXFit: minX, maxXFit: maxX };
    }

    // --- Plotting & Exports (No Changes here) ---
    // (Existing updateAllPlots, updateTables, downloadCSV, generatePDF functions remain the same)
    // I have omitted them here to save space, but you should keep them exactly as they were in your previous script.
    // If you copied the whole script block, ensure updateAllPlots, updateTables, downloadCSV, and generatePDF 
    // are included at the bottom before the closing brace '})'.

    window.updateAllPlots = function() {
        const visibleDS = datasets.filter(d => d.visible);
        const layoutCommon = {
            margin: { t: 30, r: 20, l: 60, b: 50 },
            showlegend: true,
            legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.8)' },
            plot_bgcolor: "white",
            paper_bgcolor: "white",
            xaxis: { showgrid: true, gridcolor: '#f1f5f9', zeroline: true, zerolinecolor: '#cbd5e1' },
            yaxis: { showgrid: true, gridcolor: '#f1f5f9', zeroline: true, zerolinecolor: '#cbd5e1' },
            font: { family: 'Inter, sans-serif' }
        };
        const configCommon = { responsive: true, displaylogo: false };

        const uniqueX = new Set(visibleDS.map(d => d.params.xUnit));
        const uniqueY = new Set(visibleDS.map(d => d.params.yType));

        let rawXTitle = "Input X";
        let rawYTitle = "Input Y";
        if (uniqueX.size === 1) {
            const u = [...uniqueX][0];
            rawXTitle = (u === 'nm') ? "Wavelength (nm)" : "Energy (eV)";
        }
        if (uniqueY.size === 1) {
            const t = [...uniqueY][0];
            if (t === 'refl') rawYTitle = "Reflectance (%)";
            else if (t === 'abs') rawYTitle = "Absorbance (A)";
            else if (t === 'trans') rawYTitle = "Transmittance (%)";
        }

        const rawTraces = visibleDS.map(ds => ({
            x: ds.rawX,
            y: ds.rawY,
            mode: 'lines',
            name: ds.name,
            line: { color: ds.color, width: 2 }
        }));
        
        Plotly.react('plotDiv', rawTraces, 
            { ...layoutCommon, title: 'Raw Spectra', xaxis: { ...layoutCommon.xaxis, title: rawXTitle }, yaxis: { ...layoutCommon.yaxis, title: rawYTitle } }, 
            configCommon
        );

        const createFitTraces = (ds, yDataArr, fitObj) => {
            let traces = [];
            traces.push({ x: ds.calc.eV, y: yDataArr, mode: 'lines', name: ds.name, line: {width: 2, color: ds.color, opacity: 0.5}, showlegend: true });

            if (fitObj.valid && fitObj.m !== 0) {
                traces.push({ x: [fitObj.Eg, fitObj.minXFit], y: [0, fitObj.m * fitObj.minXFit + fitObj.c], mode: 'lines', showlegend: false, line: { dash: 'dash', width: 1, color: '#333' }, hoverinfo: 'skip' });
                traces.push({ x: [fitObj.minXFit, fitObj.maxXFit], y: [fitObj.m * fitObj.minXFit + fitObj.c, fitObj.m * fitObj.maxXFit + fitObj.c], mode: 'lines', name: `Fit ${ds.name} (Eg=${fitObj.Eg.toFixed(2)})`, line: { dash: 'solid', width: 3, color: ds.color } });
            }
            return traces;
        };

        let directTraces = [];
        visibleDS.forEach(ds => directTraces.push(...createFitTraces(ds, ds.calc.directY, ds.calc.fitDirect)));
        Plotly.react('directPlotDiv', directTraces, 
            { ...layoutCommon, title: 'Direct Bandgap', xaxis: { ...layoutCommon.xaxis, title: 'Energy (eV)'}, yaxis: { ...layoutCommon.yaxis, title: '(αhν)²'} }, 
            configCommon
        );

        let indirectTraces = [];
        visibleDS.forEach(ds => indirectTraces.push(...createFitTraces(ds, ds.calc.indirectY, ds.calc.fitIndirect)));
        Plotly.react('indirectPlotDiv', indirectTraces, 
            { ...layoutCommon, title: 'Indirect Bandgap', xaxis: { ...layoutCommon.xaxis, title: 'Energy (eV)'}, yaxis: { ...layoutCommon.yaxis, title: '(αhν)⁰\u00B7\u2075'} }, 
            configCommon
        );
        updateTables(visibleDS);
    }

    function updateTables(visibleDS) {
        const updateTbody = (id, key) => {
            const tbody = document.querySelector(`#${id} tbody`);
            tbody.innerHTML = '';
            visibleDS.forEach(ds => {
                const fit = ds.calc[key];
                const egText = `${fit.Eg.toFixed(3)} <span class="text-muted small" style="font-size:0.75em">±${fit.EgErr.toFixed(3)}</span>`;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><span style="color:${ds.color}">●</span> ${ds.name}</td><td><span class="badge-eg">${egText}</span></td><td>${fit.R2.toFixed(4)}</td><td class="text-muted small">${fit.m.toExponential(2)}</td>`;
                tbody.appendChild(tr);
            });
        };
        updateTbody('directTable', 'fitDirect');
        updateTbody('indirectTable', 'fitIndirect');
    }

    window.downloadCSV = function() {
        const visibleDS = datasets.filter(d => d.visible);
        if (visibleDS.length === 0) return;
        const esc = (val) => {
            if (val === null || val === undefined) return "";
            const str = String(val);
            return str.includes(",") ? `"${str}"` : str;
        };
        let rows = [];
        rows.push(["=== SUMMARY RESULTS ==="]);
        rows.push(["File Name", "Bandgap Mode", "Eg (eV)", "R-Squared", "Slope"].join(","));
        visibleDS.forEach(ds => {
            rows.push([esc(ds.name), "Direct", ds.calc.fitDirect.Eg.toFixed(4), ds.calc.fitDirect.R2.toFixed(4), ds.calc.fitDirect.m.toExponential(4)].join(","));
            rows.push([esc(ds.name), "Indirect", ds.calc.fitIndirect.Eg.toFixed(4), ds.calc.fitIndirect.R2.toFixed(4), ds.calc.fitIndirect.m.toExponential(4)].join(","));
        });
        rows.push([], [], ["=== SPECTRAL DATA ==="]);
        let dataHeader = ["Index"];
        visibleDS.forEach(ds => {
            const n = esc(ds.name);
            dataHeader.push(`${n}_eV`, `${n}_DirectY`, `${n}_IndirectY`);
        });
        rows.push(dataHeader.join(","));
        const maxLen = Math.max(...visibleDS.map(d => d.calc.eV.length));
        for (let i = 0; i < maxLen; i++) {
            let row = [i];
            visibleDS.forEach(ds => {
                if (i < ds.calc.eV.length) {
                    row.push(ds.calc.eV[i].toFixed(5), ds.calc.directY[i].toFixed(5), ds.calc.indirectY[i].toFixed(5));
                } else {
                    row.push("","","");
                }
            });
            rows.push(row.join(","));
        }
        const blob = new Blob([rows.join("\r\n")], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `multi_tauc_analysis.csv`;
        link.click();
    };

    window.generatePDF = async function() {
        const visibleDS = datasets.filter(d => d.visible);
        if (visibleDS.length === 0) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFillColor(15, 23, 42); 
        doc.rect(0, 0, 210, 38, 'F'); 
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.text("Multi-Tauc Analysis Report", 14, 12);
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);
        doc.setFontSize(9);
        doc.setTextColor(200, 200, 200); 
        doc.text(`Source: ${window.location.href}`, 14, 28);
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'normal');
        let yPos = 48;
        const addResultsTable = (title, key) => {
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(title, 14, yPos);
            yPos += 8;
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setFillColor(241, 245, 249);
            doc.rect(14, yPos - 5, 180, 7, 'F');
            doc.text("File", 16, yPos);
            doc.text("Eg (eV) ± Error", 85, yPos);
            doc.text("R2", 135, yPos);
            doc.text("Slope", 160, yPos);
            yPos += 8;
            visibleDS.forEach(ds => {
                const fit = ds.calc[key];
                let name = ds.name.length > 35 ? ds.name.substring(0,32)+'...' : ds.name;
                doc.text(name, 16, yPos);
                doc.text(`${fit.Eg.toFixed(3)} ± ${fit.EgErr.toFixed(3)}`, 85, yPos);
                doc.text(`${fit.R2.toFixed(4)}`, 135, yPos);
                doc.text(`${fit.m.toExponential(2)}`, 160, yPos);
                yPos += 6;
            });
            yPos += 10;
        };
        addResultsTable("Direct Bandgap Results", "fitDirect");
        addResultsTable("Indirect Bandgap Results", "fitIndirect");
        const grabPlot = async (divId) => await Plotly.toImage(document.getElementById(divId), {format: 'png', width: 800, height: 400, scale: 2});
        if (yPos > 180) { doc.addPage(); yPos = 20; }
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text("Raw Spectra", 14, yPos);
        const imgRaw = await grabPlot('plotDiv');
        doc.addImage(imgRaw, 'PNG', 15, yPos + 5, 180, 90);
        yPos += 100; 
        if (yPos > 200) { doc.addPage(); yPos = 20; } 
        doc.text("Direct Bandgap Plot", 14, yPos);
        const imgDir = await grabPlot('directPlotDiv');
        doc.addImage(imgDir, 'PNG', 15, yPos + 5, 180, 90);
        doc.addPage();
        doc.text("Indirect Bandgap Plot", 14, 20);
        const imgInd = await grabPlot('indirectPlotDiv');
        doc.addImage(imgInd, 'PNG', 15, 25, 180, 90);
        doc.save(`Tauc_Report_${Date.now()}.pdf`);
    };

});

</script>


</body>
</html>